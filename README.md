# Nuts Node Pentest Setup

This setup has been published on https://github.com/nuts-foundation/pentest-setup

The following has been set up:

- Nuts Node with all its HTTP APIs exposed on port `1323`,
- with a DID document configured as node DID (connection authentication): `did:nuts:8fbYxyYNNDjyTMyEQuusptr7LjirQYHxKFtw7qi2Szb1`
- with a NutsOrganizationCredential issued to it (required for access token flow)

When the Nuts Node interacts with a "remote node" (requesting access token) it actually uses the local node,
which is OK since remote nodes will run the same software (albeit maybe a different version).

The node has been configured to use "strict mode" which disallows unsafe default configurations.

## TLS

TLS has been disabled on HTTP endpoints. In a production situation, the following paths (and their subpaths) should be secured by TLS:

- `/public` with a publicly trusted server certificate.
- `/n2n` with a PKIoverheid Private server certificate, also requiring a client certificate (same chain).
- gRPC with a PKIoverheid Private server certificate, also requiring a client certificate (same chain).
- Other endpoints aren't secured with TLS, since they're meant for internal use (administrative apps, monitoring)

## Private keys

Persisted on disk found in `./data/crypto` (host mount) and `/opt/data/crypto` (in container).

## Endpoints of Interest

The following endpoints are considered of interest due to their attack surface.
They are in order of criticalness (topmost is deemed most critical).

Refer to https://nuts-node.readthedocs.io/en/stable/pages/integrating/api.html?urls.primaryName=Auth for further reference.

### Creating an Access Token
HTTP endpoint called by other Nuts nodes to create a JWT token, which is used to gain access to medical data at other parties.
It uses the OAuth grant token flow: the local node signs a grant token, which is exchanged at the target Nuts node for a JWT (bearer) access token.
The latter is then used for gaining access to medical data.

Step 1: create JWT grant token at local node (see `http-requests/create-access-token.http` step 1):
```http request
POST /internal/auth/v1/jwt-grant
```

Step 2: exchange for access token at remote node (see `http-requests/create-access-token.http` step 2):
```http request
POST /n2n/auth/v1/accesstoken
```

### gRPC Network Protocol
Nuts nodes communicate using a gRPC network protocol, available on port `5555`.

### Public IRMA endpoints
IRMA authentication uses a mobile app which communicates with publicly available endpoints, exposed by the Nuts Node.

Creating an IRMA signing session:

```http request
POST /public/auth/irmaclient/session
```

Querying the status of a session:

```http request
GET /public/auth/irmaclient/session/<token>
```

### Signing a JWT

```http request
POST /internal/crypto/v1/sign_jwt
```

### Nuts Node status
Endpoint for returning node status (OK/not OK).

```http request
GET /status
```

### Diagnosing Nuts Node
Endpoint for returning detailed node status in JSON or YAML format (depends on `Accept` header).

```http request
GET /status/diagnostics
```

### Monitoring Nuts Node
Endpoint for returning Prometheus metrics of the node.

```http request
GET /metrics
```